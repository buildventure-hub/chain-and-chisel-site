<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Request | Chain & Chisel</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Cloudflare Turnstile widget script -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>

  <aside class="side-brand" aria-label="Site navigation">
    <img class="brand-logo" src="Chain-&-Chisel-Logo.png" alt="Chain & Chisel Logo" />
    <nav class="plank-nav">
      <a class="plank-link" href="index.html"><span>Gallery</span></a>
      <a class="plank-link" href="about.html"><span>About</span></a>
      <a class="plank-link" href="faq.html"><span>FAQ</span></a>
    </nav>
  </aside>

  <main class="page">
    <h1 class="section-title">Order Request</h1>

    <div class="content-card">
      <p>
        Fill out the request details below. After you pass the “Are you human” check, the Email button will unlock.
      </p>

      <p style="opacity:0.85;">
        Note: Turnstile tokens are meant to be validated server-side for real bot protection. A mailto-only workflow can’t validate the token.
      </p>

      <form id="orderForm" onsubmit="return false;">
        <h3 style="margin-top:0;">Contact</h3>

        <label for="firstName">First name</label><br/>
        <input id="firstName" type="text" autocomplete="given-name"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" /><br/><br/>

        <label for="lastName">Last name</label><br/>
        <input id="lastName" type="text" autocomplete="family-name"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" /><br/><br/>

        <label for="phone">Phone</label><br/>
        <input id="phone" type="tel" autocomplete="tel"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" placeholder="(###) ###-####" /><br/><br/>

        <h3>Address</h3>

        <label for="street">Street address</label><br/>
        <input id="street" type="text" autocomplete="street-address"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" /><br/><br/>

        <label for="city">City</label><br/>
        <input id="city" type="text" autocomplete="address-level2"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" /><br/><br/>

        <label for="zip">ZIP</label><br/>
        <input id="zip" type="text" inputmode="numeric" autocomplete="postal-code"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" /><br/><br/>

        <h3>Tree / Material</h3>

        <label for="species">Tree species you would like carved</label><br/>
        <input id="species" type="text"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" placeholder="e.g., pine, cottonwood, aspen…" /><br/><br/>

        <label for="circumference">Trunk circumference</label><br/>
        <input id="circumference" type="text"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" placeholder="e.g., 48 in (or 122 cm)" /><br/><br/>

        <div style="display:grid; gap:10px; margin: 6px 0 18px;">
          <label style="display:flex; gap:10px; align-items:center;">
            <input id="treeDry" type="checkbox" />
            <span>Tree is dry (sitting for years)</span>
          </label>
          <label style="display:flex; gap:10px; align-items:center;">
            <input id="treeGreen" type="checkbox" />
            <span>Tree is green (freshly cut)</span>
          </label>
        </div>

        <h3>Project description</h3>
        <label for="description">Description</label><br/>
        <textarea id="description" rows="7"
                  style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;"
                  placeholder="Tell us what you want carved, size, style, deadline, budget range, delivery needs, photos/links, etc."></textarea><br/><br/>

        <!-- Turnstile widget -->
        <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY" data-callback="onHuman"></div>

        <br/>
        <button id="submitBtn" class="plank-link" type="button" disabled><span>Send Request</span></button>
        <p id="formStatus" style="opacity:0.9; margin-top:10px;"></p>
        <p style="opacity:0.8; margin-top:10px;">
          Replace <code>YOUR_TURNSTILE_SITE_KEY</code> with your Cloudflare Turnstile site key.
        </p>
      </form>
    </div>
  </main>
<script>
  let turnstileToken = "";

  function buildPayload(){
    return {
      firstName: document.getElementById('firstName').value || "",
      lastName: document.getElementById('lastName').value || "",
      phone: document.getElementById('phone').value || "",
      street: document.getElementById('street').value || "",
      city: document.getElementById('city').value || "",
      zip: document.getElementById('zip').value || "",
      species: document.getElementById('species').value || "",
      circumference: document.getElementById('circumference').value || "",
      treeDry: document.getElementById('treeDry').checked,
      treeGreen: document.getElementById('treeGreen').checked,
      description: document.getElementById('description').value || "",
      turnstileToken
    };
  }

  function setStatus(msg, isError=false){
    const el = document.getElementById('formStatus');
    if(!el) return;
    el.textContent = msg;
    el.style.color = isError ? "#ffb3b3" : "#cfe8cf";
  }

  // Turnstile success callback (token provided by Cloudflare)
  function onHuman(token){
    turnstileToken = token || "";
    const btn = document.getElementById('submitBtn');
    if(btn){
      btn.disabled = !turnstileToken;
    }
    if(turnstileToken){
      setStatus("Verified. You can send your request now.", false);
    }
  }

  async function submitRequest(){
    const btn = document.getElementById('submitBtn');
    if(!turnstileToken){
      setStatus("Please complete the verification first.", true);
      return;
    }

    const payload = buildPayload();

    // Minimal required fields
    if(!payload.firstName || !payload.lastName || !payload.phone){
      setStatus("Please fill in First name, Last name, and Phone.", true);
      return;
    }
    if(!payload.description){
      setStatus("Please add a short description of what you want carved.", true);
      return;
    }

    if(btn) btn.disabled = true;
    setStatus("Sending…", false);

    try{
      const res = await fetch("/api/order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));

      if(!res.ok || !data.ok){
        throw new Error(data.error || ("Request failed (" + res.status + ")"));
      }

      setStatus("Sent! We'll get back to you soon.", false);
    }catch(err){
      setStatus(String(err.message || err), true);
      if(btn) btn.disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    const btn = document.getElementById('submitBtn');
    if(btn){
      btn.addEventListener("click", submitRequest);
    }
  });
</script>

</body>
</html>
